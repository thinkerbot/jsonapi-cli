#!/usr/bin/env ruby
require 'rubygems'
require 'bundler'
Bundler.setup

begin
  require 'optparse'
  require 'jsonapi_cli'
  require 'json'
  require 'shellwords'

  options = JsonapiCli.options(
    :mode => :payloads,
    :num  => 1,
    :resource_options => {},
  )
  OptionParser.new do |opts|
    opts.banner = %{
usage: jsonapi-generate [options] RESOURCE[:COUNT] ...

  Generate payloads from resource descriptions.

options:

}.lstrip

    opts.on("--[no-]attributes-only", "generate attributes onlu") do |value|
      options[:mode] = value ? :attributes : :payloads
    end

    opts.on("-h", "--help", "print this help") do
      puts opts
      puts
      puts JsonapiCli.version
      exit
    end

    opts.on("-l", "--list", "list available resources") do
      options[:mode] = :list
    end

    opts.on("-L", "--list-mode MODE", "sets list mode ") do |value|
      options[:resource_options][:list_mode] = value.to_sym
    end

    opts.on("-n", "--num NUM", "number of each resource to generate") do |value|
      options[:num] = value
    end

    opts.on("-s", "--seed SEED", "set seed value") do |value|
      options[:seed] = value
    end
  end.parse!

  config = JsonapiCli.setup(options)
  resource_specs = ARGV.dup; ARGV.clear

  mode = options[:mode]

  if mode == :list
    puts config.resource_classes.map(&:type).sort.join("\n")
    exit
  end

  $stderr.puts "seed: #{config.seed}"

  default_num  = options[:num].to_i
  resource_options = options[:resource_options]

  cache = config.cache
  resource_specs.each do |spec|
    type, num = spec.split(":", 2)
    num = num ? num.to_i : default_num 

    resource_class = config.resource_class(type)
    num.to_i.times do
      resource = resource_class.create(resource_options, cache)
      resource.save
    end
  end

  picks = []

  cache.each do |resource|
    resource.class.relationships.properties.each_pair do |name, relationship|
      picks.concat relationship.generate_picks(resource)
    end
  end

  picks.each do |resource, relationship, index|
    relationship.process_pick(resource, index)
  end

  cache.each do |resource|
    case mode
    when :attributes
      puts resource.attributes.to_json
    when :payloads
      puts resource.payload.to_json
    end
  end

rescue Interrupt
  exit 130
rescue Errno::EPIPE
  exit 0
end

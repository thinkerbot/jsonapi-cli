#!/usr/bin/env ruby
require 'rubygems'
require 'bundler'
Bundler.setup

begin
  require 'optparse'
  require 'jsonapi_cli'
  require 'jsonapi_cli/resource'
  require 'json'
  require 'shellwords'

  options = {
    :mode => :payloads,
    :seed => ENV['JSONAPI_SEED'],
    :num  => 1,
    :resource_options => {},
  }
  OptionParser.new do |opts|
    opts.banner = %{
usage: jsonapi-generate [options] RESOURCE_FILES...

  Generate payloads from resource descriptions.

options:

}.lstrip

    opts.on("--[no-]attributes-only", "generate attributes onlu") do |value|
      options[:mode] = value ? :attributes : :payloads
    end

    opts.on("-h", "--help", "print this help") do
      puts opts
      puts
      puts JsonapiCli.version
      exit
    end

    opts.on("-l", "--list-mode MODE", "sets list mode ") do |value|
      options[:resource_options][:list_mode] = value.to_sym
    end

    opts.on("-n", "--num NUM", "number of each resource to generate") do |value|
      options[:num] = value
    end

    opts.on("-s", "--seed SEED", "set seed value") do |value|
      options[:seed] = value
    end
  end.parse!

  resource_files = ARGV.dup; ARGV.clear

  resource_files.each do |file|
    locale_file = File.expand_path(file).chomp(".rb") + ".yml"
    if File.exists?(locale_file)
      I18n.load_path << locale_file
    end
  end

  resource_files.each do |file|
    require File.expand_path(file)
  end

  if seed = options[:seed]
    Random.srand(seed.to_i)
  end

  mode = options[:mode]
  num  = options[:num].to_i
  resource_options = options[:resource_options]

  JsonapiCli::Resource.each do |resource_class|
    num.to_i.times do
      resource = resource_class.create(resource_options)
      case mode
      when :attributes
        puts resource.attributes.to_json
      when :payloads
        puts resource.payload.to_json
      end
    end
  end

rescue Interrupt
  exit 130
rescue Errno::EPIPE
  exit 0
end
